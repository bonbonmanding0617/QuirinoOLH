<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Quirino Online Library Hub</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .admin-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: calc(100vh - 70px);
        }

        .admin-sidebar {
            background-color: var(--bg-white);
            border-right: 1px solid var(--border-color);
            padding: 2rem 0;
            box-shadow: var(--shadow);
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu a {
            display: block;
            padding: 1rem 1.5rem;
            color: var(--text-dark);
            font-weight: 500;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: var(--very-light-orange);
            border-left-color: var(--primary-orange);
            color: var(--primary-orange);
        }

        .admin-content {
            padding: 2rem;
            overflow-y: auto;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .analytics-panel {
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
        }

        .analytics-table thead {
            background-color: var(--very-light-orange);
        }

        .analytics-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        .analytics-table td {
            padding: 1rem;
            border: 1px solid var(--border-color);
        }

        .analytics-table tbody tr:hover {
            background-color: var(--bg-light);
        }

        .chart-placeholder {
            height: 300px;
            background: linear-gradient(135deg, var(--very-light-orange) 0%, rgba(230, 126, 34, 0.1) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7F8C8D;
            text-align: center;
            margin-bottom: 1rem;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .rank-item:last-child {
            border-bottom: none;
        }

        .rank-number {
            font-weight: 700;
            color: var(--primary-orange);
            font-size: 1.2rem;
            margin-right: 1rem;
            width: 40px;
        }

        .rank-info {
            flex: 1;
        }

        .rank-label {
            font-weight: 600;
            color: var(--text-dark);
        }

        .rank-value {
            color: var(--secondary-orange);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .admin-layout {
                grid-template-columns: 1fr;
            }

            .admin-sidebar {
                display: none;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .analytics-table {
                font-size: 0.9rem;
            }

            .analytics-table th,
            .analytics-table td {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <img src="../Logo/1000.png" alt="QOLH Logo" style="height: 40px;">
                <span>Analytics Dashboard</span>
            </div>
            <div class="navbar-user">
                <span id="admin-name" style="font-weight: 600; margin-right: 1rem;">Admin</span>
                <button onclick="handleLogout()" class="btn btn-small btn-outline">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Admin Layout -->
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <ul class="sidebar-menu">
                <li><a href="admin-dashboard.html">üìä Dashboard</a></li>
                <li><a href="admin-students.html">üë• Student Management</a></li>
                <li><a href="admin-teachers.html">üë®‚Äçüè´ Teacher Management</a></li>
                <li><a href="admin-books.html">üìö Books Management</a></li>
                <li><a href="admin-ebooks.html">üíæ eBooks Management</a></li>
                <li><a href="admin-approvals.html">‚úÖ Approval Requests</a></li>
                <li><a href="admin-analytics.html" class="active">üìà Analytics</a></li>
                <li><a href="admin-profile.html">üë§ My Profile</a></li>
                <li><a href="admin-settings.html">‚öôÔ∏è Settings</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <h2 style="margin-top: 0;">üìä Library Analytics</h2>

            <!-- Key Statistics -->
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-value" id="total-borrows">0</div>
                    <div class="stat-label">Total Borrows</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="total-returns">0</div>
                    <div class="stat-label">Total Returns</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="active-borrows">0</div>
                    <div class="stat-label">Active Borrows</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="overdue-borrows">0</div>
                    <div class="stat-label">Overdue Borrows</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-grid">
                <div class="analytics-panel">
                    <h3>üìä Monthly Borrowing Activity</h3>
                    <div class="chart-container">
                        <canvas id="borrowing-chart"></canvas>
                    </div>
                </div>

                <div class="analytics-panel">
                    <h3>üìà Borrow Status Distribution</h3>
                    <div class="chart-container">
                        <canvas id="status-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="analytics-panel">
                    <h3>üìö Book Category Distribution</h3>
                    <div class="chart-container">
                        <canvas id="category-chart"></canvas>
                    </div>
                </div>

                <div class="analytics-panel">
                    <h3>üéØ Top 5 Categories</h3>
                    <div class="chart-container">
                        <canvas id="top-categories-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Students -->
            <div class="analytics-panel">
                <h3>üèÜ Top Borrowing Students</h3>
                <div id="top-students-container">
                    <!-- Top students will be loaded here -->
                </div>
            </div>

            <!-- Top Books -->
            <div class="analytics-panel">
                <h3>üìö Most Borrowed Books</h3>
                <div id="top-books-container">
                    <!-- Top books will be loaded here -->
                </div>
            </div>

            <!-- Borrowing Activity Table -->
            <div class="analytics-panel">
                <h3>üìã Recent Borrowing Activity</h3>
                <div style="overflow-x: auto;">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Book Title</th>
                                <th>Borrowed Date</th>
                                <th>Due Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="activity-tbody">
                            <!-- Activity records will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let currentUser = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            currentUser = getCurrentUser();

            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'teacher')) {
                window.location.href = 'admin-login.html';
                return;
            }

            document.getElementById('admin-name').textContent = currentUser.name;
            loadAnalytics();
        });

        // Load analytics data
        function loadAnalytics() {
            const token = localStorage.getItem('token');
            
            // Load borrow records for statistics
            axios.get('http://localhost:3001/api/borrow', {
                headers: { Authorization: 'Bearer ' + token }
            })
                .then(res => {
                    const records = res.data.records;
                    const totalBorrows = records.length;
                    const totalReturns = records.filter(r => r.status === 'returned').length;
                    const activeBorrows = records.filter(r => r.status === 'borrowed').length;
                    const overdueBorrows = records.filter(r => {
                        if (r.status === 'borrowed') {
                            return new Date(r.dueDate) < new Date();
                        }
                        return false;
                    }).length;

                    document.getElementById('total-borrows').textContent = totalBorrows;
                    document.getElementById('total-returns').textContent = totalReturns;
                    document.getElementById('active-borrows').textContent = activeBorrows;
                    document.getElementById('overdue-borrows').textContent = overdueBorrows;

                    // Calculate top students and books from records
                    const studentBorrows = {};
                    const bookBorrows = {};
                    const monthlyBorrows = {};
                    const categoryBorrows = {};
                    
                    records.forEach(record => {
                        studentBorrows[record.studentId] = (studentBorrows[record.studentId] || 0) + 1;
                        bookBorrows[record.bookId] = (bookBorrows[record.bookId] || 0) + 1;
                        
                        // Monthly data
                        const date = new Date(record.borrowDate);
                        const monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                        monthlyBorrows[monthKey] = (monthlyBorrows[monthKey] || 0) + 1;
                    });

                    const topStudents = Object.entries(studentBorrows)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([id, count]) => ({ studentId: id, borrowCount: count }));
                    
                    const topBooks = Object.entries(bookBorrows)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([id, count]) => ({ bookId: id, borrowCount: count }));

                    loadTopStudents(topStudents);
                    loadTopBooks(topBooks);
                    loadRecentActivity(records);
                    
                    // Initialize charts
                    initBorrowingChart(monthlyBorrows);
                    initStatusChart(totalReturns, activeBorrows, overdueBorrows);
                    
                    // Load books to get category data
                    return axios.get('http://localhost:3001/api/books', {
                        headers: { Authorization: 'Bearer ' + token }
                    });
                })
                .then(res => {
                    const books = res.data.books;
                    const categoryBorrows = {};
                    
                    // Count borrows by category from books
                    books.forEach(book => {
                        const category = book.category || 'Uncategorized';
                        categoryBorrows[category] = (categoryBorrows[category] || 0) + (book.quantity - book.available);
                    });
                    
                    initCategoryChart(categoryBorrows);
                    initTopCategoriesChart(categoryBorrows);
                })
                .catch(err => {
                    console.log('Failed to load analytics:', err);
                    alert('Failed to load analytics data');
                });
        }

        // Initialize borrowing trend chart (bar)
        function initBorrowingChart(monthlyBorrows) {
            const ctx = document.getElementById('borrowing-chart').getContext('2d');
            
            const months = Object.keys(monthlyBorrows).sort();
            const data = months.map(m => monthlyBorrows[m]);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Books Borrowed',
                        data: data,
                        backgroundColor: 'rgba(230, 126, 34, 0.7)',
                        borderColor: 'rgba(230, 126, 34, 1)',
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Initialize status pie chart
        function initStatusChart(returned, active, overdue) {
            const ctx = document.getElementById('status-chart').getContext('2d');
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Returned', 'Active Borrows', 'Overdue'],
                    datasets: [{
                        data: [returned, active, overdue],
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(231, 76, 60, 0.7)'
                        ],
                        borderColor: [
                            'rgba(46, 204, 113, 1)',
                            'rgba(52, 152, 219, 1)',
                            'rgba(231, 76, 60, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Initialize category pie chart
        function initCategoryChart(categoryBorrows) {
            const ctx = document.getElementById('category-chart').getContext('2d');
            
            const categories = Object.keys(categoryBorrows);
            const data = categories.map(c => categoryBorrows[c]);
            
            const colors = [
                'rgba(230, 126, 34, 0.7)',
                'rgba(52, 152, 219, 0.7)',
                'rgba(46, 204, 113, 0.7)',
                'rgba(155, 89, 182, 0.7)',
                'rgba(241, 196, 15, 0.7)',
                'rgba(230, 126, 34, 0.5)',
                'rgba(52, 152, 219, 0.5)',
                'rgba(46, 204, 113, 0.5)'
            ];
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: categories,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, categories.length),
                        borderColor: colors.slice(0, categories.length).map(c => c.replace('0.7', '1').replace('0.5', '0.8')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Initialize top categories bar chart
        function initTopCategoriesChart(categoryBorrows) {
            const ctx = document.getElementById('top-categories-chart').getContext('2d');
            
            const sorted = Object.entries(categoryBorrows)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const categories = sorted.map(item => item[0]);
            const data = sorted.map(item => item[1]);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Books Borrowed',
                        data: data,
                        backgroundColor: 'rgba(155, 89, 182, 0.7)',
                        borderColor: 'rgba(155, 89, 182, 1)',
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Load top students
        function loadTopStudents(topStudents) {
            const container = document.getElementById('top-students-container');

            if (topStudents.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7F8C8D;">No borrowing data yet</p>';
                return;
            }

            container.innerHTML = topStudents.map((item, index) => `
                <div class="rank-item">
                    <div class="rank-number">#${index + 1}</div>
                    <div class="rank-info">
                        <div class="rank-label">${item.studentId}</div>
                        <div class="rank-value">Student ID</div>
                    </div>
                    <div style="font-weight: 700; color: var(--primary-orange); font-size: 1.2rem;">
                        ${item.borrowCount} üìö
                    </div>
                </div>
            `).join('');
        }

        // Load top books
        function loadTopBooks(topBooks) {
            const container = document.getElementById('top-books-container');

            if (topBooks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7F8C8D;">No book data yet</p>';
                return;
            }

            container.innerHTML = topBooks.map((item, index) => `
                <div class="rank-item">
                    <div class="rank-number">#${index + 1}</div>
                    <div class="rank-info">
                        <div class="rank-label">${item.bookId}</div>
                        <div class="rank-value">Book ID</div>
                    </div>
                    <div style="font-weight: 700; color: var(--primary-orange); font-size: 1.2rem;">
                        ${item.borrowCount} ‚úì
                    </div>
                </div>
            `).join('');
        }

        // Load recent activity
        function loadRecentActivity(records) {
            const tbody = document.getElementById('activity-tbody');

            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No activity yet</td></tr>';
                return;
            }

            const recentRecords = records.slice(-20).reverse();
            tbody.innerHTML = recentRecords.map(record => {
                const isOverdue = record.status === 'borrowed' && new Date(record.dueDate) < new Date();
                const statusColor = record.status === 'returned' ? 'success' : 
                                   (isOverdue ? 'danger' : 'info');

                return `
                    <tr>
                        <td>${record.studentId}</td>
                        <td>${record.bookId}</td>
                        <td>${new Date(record.borrowDate).toLocaleDateString()}</td>
                        <td>${new Date(record.dueDate).toLocaleDateString()}</td>
                        <td><span class="badge badge-${statusColor}">
                            ${record.status === 'returned' ? '‚úì Returned' : 
                              (isOverdue ? '‚ö† Overdue' : 'üìñ Borrowed')}
                        </span></td>
                    </tr>
                `;
            }).join('');
        }

        // Logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                logout();
            }
        }
    </script>
</body>
</html>
